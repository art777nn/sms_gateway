version: '2.4'

x-env: &default-env
  RMQ_DSN: ${RMQ_DSN}
  POSTGRES_DSN: ${POSTGRES_DSN}
  MODEM_PORT: '/dev/ttyUSB3'
  TZ: 'Europe/Moscow'
  MQTT_HOST: ${MQTT_HOST}
  MQTT_PORT: ${MQTT_PORT}

services:
  rabbitmq:
    image: rabbitmq:management  # Используем образ RabbitMQ с поддержкой управления
    ports:
      - "5672:5672"  # Порт для подключения приложений (AMQP)
      - "15672:15672"  # Порт для веб-интерфейса управления
    environment:
      RABBITMQ_DEFAULT_USER: 'guest'  # Имя пользователя по умолчанию
      RABBITMQ_DEFAULT_PASS: 'guest'  # Пароль пользователя по умолчанию
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq  # Хранение данных RabbitMQ
    networks:
      - smsgateway

  fastapi:
    image: smsgateway
    build:
       context: .
       dockerfile: Dockerfile  # Укажите Dockerfile для вашего FastAPI приложения
    command: fastapi run app/api.py
    ports:
      - "8000:8000"
    networks:
      - smsgateway
    environment:
      <<: *default-env  # Наследование переменных окружения

  modem_worker:
    image: smsgateway
    working_dir: /var/app/app/
    command: python mf180_worker.py 
    depends_on:
      - rabbitmq
    networks:
      - smsgateway
    restart: always
    environment:
      <<: *default-env  
    devices:
      - /dev/ttyUSB3:/dev/ttyUSB3

  modem_handler:
    image: smsgateway
    working_dir: /var/app/app/
    command: python modem_handler.py 
    depends_on:
      - rabbitmq
    networks:
      - smsgateway
    restart: always
    environment:
      <<: *default-env

  frontend:
    image: smsgateway-f
    build:
       context: .
       dockerfile: Dockerfile.frontend  # Укажите Dockerfile для вашего FastAPI приложения
    networks:
      - smsgateway
    depends_on:
      - fastapi
    ports:
      - "8001:80"

  ha_integration:
    image: smsgateway
    working_dir: /var/app/app/
    command: python ha_mqtt.py
    depends_on:
      - rabbitmq
    networks:
      - smsgateway
    restart: always
    environment:
      <<: *default-env

networks:
  smsgateway:
    driver: bridge  # Используется драйвер по умолчанию
volumes:
  rabbitmq_data:  # Устойчивое хранилище для данных RabbitMQ